var chatRefreshInterval=3e4,intLoadChat=!0,intReadMessage=null,curScroll=null;function isMobile(){return $(window).width()<=480}function resetScrollAndLoadMessage(){intLoadChat=!0,intReadMessage=null,curScroll=null}function showFeatureBottom(){$(".tab-chat-feature-wrapper").show(),$(".btn-chat-file").data("state",2)}function hideFeatureBottom(){$(".chat-user-message-wrapper, .btn-chat-sticker").show(),$(".tab-chat-feature-wrapper").hide(),$(".btn-chat-file").data("state",1)}function resizeChat(){var t=$(".chat-detail-header").height(),a=$(".chat-contact-detail .chat-user").height(),e=$(".main-header").height(),i=$(".chat-history-wrapper").height();$(".chat-user").width($(".chat-history").width()-20),$(".chat-box").height($(window).height()-48),$(window).width()<=480?($(".chat-box").height($(window).height()),$(".chat-history").height(i-(a+t)-e-30)):($(".chat-box").height($(window).height()-48),$(".chat-history").height(i-(a+t)-e+70))}function uid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var a=16*Math.random()|0;return("x"==t?a:3&a|8).toString(16)}).toUpperCase()}emojify.setConfig({img_dir:"https://cdnjs.cloudflare.com/ajax/libs/emojify.js/1.1.0/images/basic"}),$(window).resize(function(t){}),$(document).ready(function(){var t=new FireNotif,a=new Audio(BASE_URL+"asset/module/chat/audio/notif2.mp3"),e=new Audio(BASE_URL+"asset/module/chat/audio/notif-open.mp3"),i=ccfb.def_url,c=ccfb.key;t.setKey(c).setUrl(i).setPath("notify-user/"+usr.uid),t.subscribe(function(t){if(t.chat_id==$(".chat-id").val()){var i=s.parseSingleMessage({id:t.id,uid:t.uid,message_user_id:t.message_user_id,status:t.status,created_at:moment(t.created_at).format("YYYY-MM-DD HH:mm"),message:t.message});$('.chat-item-user[data-message-id="'+t.uid+'"]').length?$('.chat-item-user[data-message-id="'+t.uid+'"]').replaceWith(i):$(".chat-history-wrapper .chat-history").append(i),s.createBigEmoji(),t.message_user_id!=userId&&s.addBadgeNotif(),$(".chat-contact-detail .chat-history").scrollTop()>$(".chat-contact-detail .chat-history").prop("scrollHeight")-700&&(t.message_user_id!=userId&&(clearInterval(intReadMessage),intReadMessage=setTimeout(function(){s.readMessage(t.chat_id,t.message_user_id,function(){$('.chat-item[data-id="'+t.chat_id+'"]').find(".counter-incomming-message").fadeOut()})},1e3)),$(".chat-contact-detail .chat-history").scrollTop(99999999)),$(".chat-item-typing").addClass("chat-item-typing-inactive")}t.message_user_id!=userId&&(s.notify(t),t.chat_id==$(".chat-id").val()?e.play():a.play()),s.parseImage(),n(function(){$('.chat-item[data-id="'+$(".chat-id").val()+'"]').addClass("active-chat-contact")})}),$(".btn-new-chat").click(function(t){t.preventDefault(),$(".new-chat-contact").animate({left:0},"fast")}),$(".btn-back-chat").click(function(t){t.preventDefault(),$(".new-chat-contact").animate({left:"-100%"},"fast")}),$("[contenteditable]").focusout(function(){var t=$(this);t.text().trim().length||t.empty()}),$(".main-footer").remove(),setInterval(resizeChat,10),resizeChat(),$(document).on("keyup keypress keydown change",".chat-message",function(t){resizeChat()}),$(".web-body").addClass("sidebar-collapse"),$(".chat-contact-wrapper").slimScroll({height:450,size:"10px",alwaysVisible:!0}),$(".chat-history").css("overflow","auto"),$(".chat-history").css("overflow","auto"),$("body,html").css("overflow","hidden");var s=new CicoolChat;function n(t){s.getConversations(function(a){var e=s.parseContacts(a);$(".chat-contact-message-wrapper").html(e),void 0!==t&&t(a)})}s.init();function o(){var t=$(".chat-id").val(),a=$(".chat-message-user-send").html(),e=a,i="",c=$("input[name^=chat_image_name]").map(function(t,a){var e=$(a).attr("name").match(/chat_image_name\[(\d+)\]/),c=$(".qq-thumbnail-selector").eq(t).attr("src");return i+=' <img class="chat-image-attchment-holder" src="'+c+'"> '," [image="+$('[name="chat_image_uuid['+e[1]+']"]').val()+"/"+$(a).val()+"] "}).get();if(null!=c&&(a+=c,e=e+" "+i),a.trim(),0!=(a=emojione.toShort(a)).length){e=ccChatFilter.filter(e,"liveMessage");var n=uid(),o=$(".chat-contact-detail .chat-history");o.append(s.parseSingleMessage({id:n,message_user_id:userId,status:"pending",created_at:moment().format("YYYY-MM-DD HH:mm"),message:e,uid:n})),s.grouppingMessage(),o.scrollTop(99999999999),$(".chat-message-user-send ").html(""),s.sendMessage(n,t,a,function(t){$("#chat_image_galery").find("li").each(function(){$("#chat_image_galery").fineUploader("deleteFile",$(this).attr("qq-file-id"))}),$(".chat-contact-detail .chat-history").scrollTop(99999999999)}),hideFeatureBottom(),$(".btn-chat-sticker").attr("data-state",1).slideDown(),$(".btn-chat-sticker").find(".fa").addClass("fa-smile-o").removeClass("fa-angle-down"),$(".tab-chat-feature-wrapper-top").hide()}}$(document).on("click",".chat-contact-wrapper:not(.chat-search-message-wrapper) .chat-item",function(t){if(!$(this).hasClass("active-chat-contact")){$(".chat-contact-detail").removeClass("inactive"),t.preventDefault();var a=$(this).attr("data-user-username"),e=$(this).attr("data-user-fullname"),i=$(this).attr("data-user-id"),c=$(this).attr("data-id"),n=$(this).attr("data-user-group");$(".chat-detail-id").val(i),$(".chat-contact-message-wrapper .chat-item").removeClass("active-chat-contact"),$(".chat-contact-message-wrapper .chat-item[data-user-id="+i+"]").addClass("active-chat-contact"),$(".chat-detail-username").val(a),$(".chat-detail-fullname").val(e),$(".chat-id").val(c),$(".chat-detail-name").html(e),$(".new-chat-contact").animate({left:"-100%"},"fast"),$(".chat-contact-detail .chat-contact-group").html(n),isMobile()&&$(".chat-contact").hide(),s.newPrivateChat(i,function(t){$(".chat-contact-detail .chat-history").html(s.parseMessages(t.messages)).scrollTop(999999999),$(".chat-id").val(t.chat.chat_uid),clearInterval(null),s.grouppingMessage(),$('.chat-item[data-id="'+t.chat.chat_uid+'"]').find(".counter-incomming-message").fadeOut(),resetScrollAndLoadMessage(),s.chatOffset=50,s.showDateTop(!1),s.showLoadingChat(!1)}).showLoadingChat(!0)}}),$(document).on("click",".chat-search-message-wrapper .chat-item",function(t){if(!$(this).hasClass("active-chat-contact")){$(".chat-contact-detail").removeClass("inactive"),t.preventDefault();var a=$(this).attr("data-user-username"),e=$(this).attr("data-user-fullname"),i=$(this).attr("data-user-id"),c=$(this).attr("data-id"),n=$(this).attr("data-message-id");$(".chat-detail-id").val(i),$(".chat-contact-message-wrapper .chat-item").removeClass("active-chat-contact"),$(".chat-contact-message-wrapper .chat-item[data-user-id="+i+"]").addClass("active-chat-contact"),$(".chat-detail-username").val(a),$(".chat-detail-fullname").val(e),$(".chat-id").val(c),$(".chat-detail-name").html(e),$(".new-chat-contact").animate({left:"-100%"},"fast"),s.loadSearchMessage(c,n,function(t){$(".chat-contact-detail .chat-history").html(""),$(".chat-contact-detail .chat-history").html(s.parseMessages(t.messages)).scrollTop(999999999),clearInterval(null),s.grouppingMessage();var a=$('.chat-item-user[data-message-id="'+n+'"]');a.addClass("chat-item-find-result"),$('.chat-item[data-id="'+c+'"]').find(".counter-incomming-message").fadeOut(),$(".chat-contact-detail .chat-history").animate({scrollTop:a.offset().top},1e3)})}}),$(".btn-chat-send").click(function(t){t.preventDefault(),o()}),$(document).on("click",".chat-contact-message-wrapper .chat-item",function(t){t.preventDefault(),$(".chat-contact-detail").removeClass("inactive"),$(".chat-contact-message-wrapper .chat-item").removeClass("active-chat-contact"),$(this).addClass("active-chat-contact")}),n(function(){}),$(".chat-message-user-send").bind("keydown","return",function(t){return t.preventDefault(),o(),!1});var r=null,h={},l=!1,d={},u=new FireNotif;u.setKey(c).setUrl(i),$(".chat-message-user-send").on("keypress",function(t){var a=$(".chat-id").val(),e=$(".chat-detail-id").val();u.setPath("notify-writing/"+e),clearInterval(null),h={from:userId,chat_id:a},l=!0}),setInterval(function(){l&&(l=!1,u.pushNotify(h))},1500);var m=new FireNotif;m.setKey(c).setUrl(i),m.setPath("notify-writing/"+userId),m.subscribe(function(t){console.log("typing",t),$('.chat-item[data-id="'+t.chat_id+'"]').addClass("chat-list-typing-active"),void 0===d&&(d[t.chat_id]=null),clearInterval(d[t.chat_id]),d[t.chat_id]=setTimeout(function(){$('.chat-item[data-id="'+t.chat_id+'"]').removeClass("chat-list-typing-active")},2e3),t.chat_id==$(".chat-id").val()&&($(".chat-item-typing").removeClass("chat-item-typing-inactive"),clearInterval(r),r=setTimeout(function(){$(".chat-item-typing").addClass("chat-item-typing-inactive"),$('.chat-item[data-id="'+t.chat_id+'"]').removeClass("chat-list-typing-active")},2e3))});var p=new FireNotif;p.setKey(c).setUrl(i),p.setPath("notify-read-chats/"+userId),p.subscribe(function(t){console.log("read chat",t),$.each(t.ids,function(a,e){$('.chat-item-user[data-message-id="'+e+'"]').find(".receiver-stat-icon").html(s.CHAT_INDICATOR_READ_ICO),$('.chat-contact-message-wrapper .chat-item[data-id="'+t.chat_id+'"]').find("svg").replaceWith(s.CHAT_INDICATOR_READ_ICO)})}),$(".btn-chat-file").click(function(t){switch($(this).data("state")){case 1:case void 0:showFeatureBottom(),$(this).data("state",2);break;case 2:hideFeatureBottom(),$(this).data("state",1)}}),$(".btn-chat-sticker").click(function(t){var a=$(this).attr("data-state"),e=$(this);switch(a){case"1":case void 0:$(".tab-chat-feature-wrapper-top").slideDown("fast"),e.attr("data-state","2"),e.find(".fa").removeClass("fa-smile-o").addClass("fa-angle-down");break;case"2":$(".tab-chat-feature-wrapper-top").slideUp("fast"),e.attr("data-state","1"),e.find(".fa").addClass("fa-smile-o").removeClass("fa-angle-down")}});var f=null;$(".search-input").keyup(function(t){clearInterval(f),f=setTimeout(function(){$(".chat-search-message-wrapper").html('\n        <div class="no-search-result">Searching For Chats..</div>\n        '),s.findChats($(".search-input").val(),function(t){var a=s.parseSearchResults(t);$(".chat-search-message-wrapper").html('\n        <div class="search-result-title">MESSAGES</div>'+a),t.length<=0&&$(".chat-search-message-wrapper").html('\n            <div class="no-search-result">No Search Results</div>\n            ')})},1e3),console.log($(this).val().length),$(this).val().length>0?($(".chat-contact-message-wrapper").parent().hide(),$(".chat-search-message-wrapper").parent().show()):($(".chat-contact-message-wrapper").parent().show(),$(".chat-search-message-wrapper").parent().hide())}).val(""),$(".search-contact").keyup(function(t){var a=$(this).val(),e=$(".chat-search-contact-wrapper ");e.find(".chat-contact-list-item").hide(),e.find(".chat-contact-list-item:regex(data-user-fullname, .*"+a+".*)").show(),e.find(".chat-contact-list-item:regex(data-user-email, .*"+a+".*)").show(),e.find(".chat-contact-list-item:regex(data-user-username, .*"+a+".*)").show()}),$("body").on("dragover",function(t){t.preventDefault(),t.stopPropagation(),showFeatureBottom(),$(".btn-chat-file").data("state",2)});var g={};g[csrf]=token,$("#chat_image_galery").fineUploader({template:"qq-template-gallery",request:{endpoint:BASE_URL+"/administrator/chat/upload_image_file",params:g},deleteFile:{enabled:!0,endpoint:BASE_URL+"/administrator/chat/delete_image_file"},thumbnails:{placeholders:{waitingPath:BASE_URL+"/asset/fine-upload/placeholders/waiting-generic.png",notAvailablePath:BASE_URL+"/asset/fine-upload/placeholders/not_available-generic.png"}},validation:{allowedExtensions:["jpg","jpeg","png","xls","xlsx","csv","gdoc","gsheet","txt","zip","rar","mov","pdf","mp3","doc","docx","ppt","pptx"],sizeLimit:0,itemLimit:5},showMessage:function(t){toastr.error(t)},callbacks:{onComplete:function(t,a,e){if(e.success){var i=$("#chat_image_galery").fineUploader("getUuid",t);$("#chat_image_galery_listed").append('<input type="hidden" class="listed_file_uuid" name="chat_image_uuid['+t+']" value="'+i+'" /><input type="hidden" class="listed_file_name" name="chat_image_name['+t+']" value="'+e.uploadName+'" />')}else toastr.error(e.error)},onDeleteComplete:function(t,a,e){0==e&&($("#chat_image_galery_listed").find('.listed_file_uuid[name="chat_image_uuid['+t+']"]').remove(),$("#chat_image_galery_listed").find('.listed_file_name[name="chat_image_name['+t+']"]').remove())}}}),$(".chat-contact-detail .chat-history").scroll(function(){s.bottomButtonMessage()}),$(".btn-bottom-history").click(function(t){t.preventDefault(),$(".chat-contact-detail .chat-history").animate({scrollTop:$(".chat-contact-detail .chat-history").prop("scrollHeight")},500),s.bottomButtonMessage(),s.resetBadgeNotif()}),$(".chat-history").on("scroll",function(){chatId=s.getConversationUser().chatId;var t=$(".chat-contact-detail .chat-history").scrollTop();intLoadChat&&(null!=curScroll&&t<=10&&curScroll>t&&(intLoadChat=!1,s.showLoadingChat(!0),s.loadMessage(chatId,s.chatOffset,function(t){if(t.total){var a=$(".chat-history .chat-item-user:first");$(".chat-contact-detail .chat-history").prepend(s.parseMessages(t.messages)),$(".chat-history").scrollTop(a.offset().top-120),s.grouppingMessage(),s.addOffset()}intLoadChat=!0,s.showLoadingChat(!1)})),curScroll=t)}),$(".smiley-panel-body .e1").click(function(t){t.preventDefault();var a=$(this).data("shortname");$(".chat-message-user-send").append(emojione.shortnameToUnicode(a))}),$(".btn-close-upload").click(function(t){t.preventDefault(),hideFeatureBottom()}),$(document).on("mouseover",".chat-history div.chat-item-user",function(t){t.preventDefault();var a=$(this).data("date");s.showDateTop(!0,s.humanDate(a))}),$(".btn-chat-top").click(function(t){t.preventDefault(),$(".chat-contact").show(),$(".new-chat-contact").css({left:"-100%"})}),$(".btn-contact-top").click(function(t){t.preventDefault(),$(".new-chat-contact").show().animate({left:"0%"})}),$(".new-chat-contact").animate({left:"-100%"},"fast")});